<!doctype html>
<html lang="nl">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="shortcut icon" href="#">

    <title>Simpel XHR-voorbeeld OpenWeatherMap</title>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>Simpel XHR-voorbeeld OpenWeatherMap</h1>
                <!-- Tekstvak en label voor zoekdata -->
                <label for="zoekterm">Geef een plaatsnaam (zelfde tijdzone als België) in</label>
                <input type="text" id="zoekterm" class="form-control my-3" placeholder="Zoekterm" value="Geel">

                <button id="buttonRequest" class="btn btn-primary my-3">
                    Klik voor Meteo data via een XMLHttpRequest
                </button>

                <div id="divResult" class="mt-3"></div>
                <div id="errorMsg" class="alert alert-danger mt-3 d-none"></div>
            </div>
        </div>
    </div>
</body>

<script>
    const divRes = document.querySelector("#divResult");
    const knop = document.querySelector("#buttonRequest");
    const zoekvak = document.querySelector("#zoekterm");
    const errorMsg = document.querySelector("#errorMsg");

    const myRequest = () => {
        // We maken een nieuwe instantie voor het XMLHttpRequest object
        const xhr = new XMLHttpRequest();

        let zoekterm = zoekvak.value; // "geel";
        let api_key = "1d32ed0e420864c2fa747ccabeb4ace7";
        let url = "https://api.openweathermap.org/data/2.5/weather?q=" + zoekterm + "&units=metric&lang=nl&appid=" + api_key;

        // We geven de nodige parameters mee voor het GET-request via de URL
        xhr.open("GET", url);

        // Callback wordt opgeroepen wanneer de request misloopt
        xhr.onerror = function () {
            // Wijzig de url in http://openweathermap.org i.p.v. http://api.openweathermap.org
            // We krijgen geen JSON terug omdat we de server niet kunnen bereiken
            divRes.innerHTML = "";
            errorMsg.classList.toggle("d-none");
            errorMsg.innerHTML = `Request failed (check de URL)`;
        };

        // Callback wordt opgeroepen als de response ontvangen is
        xhr.onload = function () {
            if (xhr.readyState === xhr.DONE) {

                if (xhr.status != 200) {
                    divRes.innerHTML = "";
                    errorMsg.classList.toggle("d-none");
                    errorMsg.innerHTML = `Error ${xhr.status}: ${xhr.statusText}`;

                    const fout = JSON.parse(xhr.responseText);
                    errorMsg.innerHTML += ` (${fout.message})`;
                } else {
                    // JSON → Object
                    let data = JSON.parse(xhr.responseText);
                    console.log(data);                    

                    // Toon de data
                    showData(data);                    
                }
            }
        };

        // Stuur de request
        xhr.send();

    };

    // We maken een functie om de data te tonen
    showData = (data) => {        
        errorMsg.classList.add("d-none");

        // We gebruiken de Internationalization om sunrise & sunset het juiste formaat te geven
        let sunrise = new Date(data.sys.sunrise * 1000).toLocaleTimeString("nl-BE");
        let sunset = new Date(data.sys.sunset * 1000).toLocaleTimeString("nl-BE");

        // Bouw een Bootstrap card met de data
        divRes.innerHTML = `
                        <div class="card shadow">
                            <div class="card-body">
                                <h3 class="card-title mb-3">${data.name}</h3>

                                <p><strong>Temperatuur:</strong> ${data.main.temp}°C</p>
                                <p><strong>Min:</strong> ${data.main.temp_min}°C</p>
                                <p><strong>Max:</strong> ${data.main.temp_max}°C</p>

                                <p><strong>Zonsopgang:</strong> ${sunrise}</p>
                                <p><strong>Zonsondergang:</strong> ${sunset}</p>
                            </div>
                        </div>
                    `;
    };

    knop.addEventListener("click", myRequest);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

</html>